/**
 * # Shelf.JS 
 * 
 * Persistent Client-Side Storage @VERSION
 * 
 * Copyright 2012 Stefano Balietti
 * GPL licenses.
 * 
 * ---
 * 
 */
(function(e){var t="0.3",n=e.store=function(e,t,r,i){return r=r||{},i=r.type&&r.type in n.types?r.type:n.type,n.verbosity>0&&n.log("I am using storage type "+i),n.types[i](e,t,r)};n.name="__shelf__",n.verbosity=0,n.types={},n.type=null,n.addType=function(e,t){n.type||(n.type=e),n.types[e]=t,n[e]=function(t,r,i){return i=i||{},i.type=e,n(t,r,i)}},n.error=function(){return"shelf quota exceeded"},n.log=function(e){console.log("Shelf v."+t+": "+e)},Object.defineProperty(n,"persistent",{set:function(){},get:function(){return n.types.length<2?!1:!0},configurable:!1}),n.decycle=function(e){return JSON&&JSON.decycle&&"function"==typeof JSON.decycle&&(e=JSON.decycle(e)),e},n.retrocycle=function(e){return JSON&&JSON.retrocycle&&"function"==typeof JSON.retrocycle&&(e=JSON.retrocycle(e)),e},n.stringify=function(e){if(!JSON||!JSON.stringify||"function"!=typeof JSON.stringify)throw new Error("JSON.stringify not found. Received non-string value and could not serialize.");return e=n.decycle(e),JSON.stringify(e)},n.parse=function(e){if("undefined"==typeof e)return undefined;if(JSON&&JSON.parse&&"function"==typeof JSON.parse)try{e=JSON.parse(e)}catch(t){n.log("Error while parsing a value","ERR")}return e=n.retrocycle(e),e},"object"==typeof module&&"function"==typeof require&&require("./lib/shelf.fs.js"),function(){function r(e){return n.parse(n.stringify(e))}var e={},t={};n.addType("volatile",function(n,i,s){return n?i===undefined?r(e[n]):(t[n]&&(clearTimeout(t[n]),delete t[n]),i===null?(delete e[n],null):(e[n]=i,s.expires&&(t[n]=setTimeout(function(){delete e[n],delete t[n]},s.expires)),i)):r(e)})}()})("undefined"!=typeof module&&"undefined"!=typeof module.exports?module.exports:this),function(e){function n(e,n){store.addType(e,function(r,i,s){var o,u,a,f,l=i,c=(new Date).getTime();if(!r){l={},f=[],a=0;try{r=n.length;while(r=n.key(a++))t.test(r)&&(u=store.parse(n.getItem(r)),u.expires&&u.expires<=c?f.push(r):l[r.replace(rprefix,"")]=u.data);while(r=f.pop())n.removeItem(r)}catch(h){}return l}r=store.name+r;if(i===undefined){o=n.getItem(r),u=o?store.parse(o):{expires:-1};if(!(u.expires&&u.expires<=c))return u.data;n.removeItem(r)}else if(i===null)n.removeItem(r);else{u=store.stringify({data:i,expires:s.expires?c+s.expires:null});try{n.setItem(r,u)}catch(h){store[e]();try{n.setItem(r,u)}catch(h){throw store.error()}}}return l})}var t=new RegExp("^"+store.name);for(var r in{localStorage:1,sessionStorage:1})try{window[r].getItem&&n(r,window[r])}catch(i){}if(!store.types.localStorage&&window.globalStorage)try{n("globalStorage",window.globalStorage[window.location.hostname]),store.type==="sessionStorage"&&(store.type="globalStorage")}catch(i){}(function(){if(store.types.localStorage)return;var e=document.createElement("div"),t="shelf";e.style.display="none",document.getElementsByTagName("head")[0].appendChild(e);try{e.addBehavior("#default#userdata"),e.load(t)}catch(n){e.parentNode.removeChild(e);return}store.addType("userData",function(n,r,i){e.load(t);var s,o,u,a,f,l=r,c=(new Date).getTime();if(!n){l={},f=[],a=0;while(s=e.XMLDocument.documentElement.attributes[a++])o=store.parse(s.value),o.expires&&o.expires<=c?f.push(s.name):l[s.name]=o.data;while(n=f.pop())e.removeAttribute(n);return e.save(t),l}n=n.replace(/[^-._0-9A-Za-z\xb7\xc0-\xd6\xd8-\xf6\xf8-\u037d\u37f-\u1fff\u200c-\u200d\u203f\u2040\u2070-\u218f]/g,"-"),n=n.replace(/^-/,"_-");if(r===undefined){s=e.getAttribute(n),o=s?store.parse(s):{expires:-1};if(!(o.expires&&o.expires<=c))return o.data;e.removeAttribute(n)}else r===null?e.removeAttribute(n):(u=e.getAttribute(n),o=store.stringify({data:r,expires:i.expires?c+i.expires:null}),e.setAttribute(n,o));try{e.save(t)}catch(h){u===null?e.removeAttribute(n):e.setAttribute(n,u),store.userData();try{e.setAttribute(n,o),e.save(t)}catch(h){throw u===null?e.removeAttribute(n):e.setAttribute(n,u),store.error()}}return l})})()}(this),function(e){(function(){var e=function(){var e,t,n,r,i={expiresAt:null,path:"/",domain:null,secure:!1};return e=function(e){var t,n;return typeof e!="object"||e===null?t=i:(t={expiresAt:i.expiresAt,path:i.path,domain:i.domain,secure:i.secure},typeof e.expiresAt=="object"&&e.expiresAt instanceof Date?t.expiresAt=e.expiresAt:typeof e.hoursToLive=="number"&&e.hoursToLive!==0&&(n=new Date,n.setTime(n.getTime()+e.hoursToLive*60*60*1e3),t.expiresAt=n),typeof e.path=="string"&&e.path!==""&&(t.path=e.path),typeof e.domain=="string"&&e.domain!==""&&(t.domain=e.domain),e.secure===!0&&(t.secure=e.secure)),t},t=function(t){return t=e(t),(typeof t.expiresAt=="object"&&t.expiresAt instanceof Date?"; expires="+t.expiresAt.toGMTString():"")+"; path="+t.path+(typeof t.domain=="string"?"; domain="+t.domain:"")+(t.secure===!0?"; secure":"")},n=function(){var e={},t,n,r,i,s=document.cookie.split(";"),o;for(t=0;t<s.length;t+=1){n=s[t].split("="),r=n[0].replace(/^\s*/,"").replace(/\s*$/,"");try{i=decodeURIComponent(n[1])}catch(u){i=n[1]}e[r]=store.parse(i)}return e},r=function(){},r.prototype.get=function(e){var t,r,i=n();if(typeof e=="string")t=typeof i[e]!="undefined"?i[e]:null;else if(typeof e=="object"&&e!==null){t={};for(r in e)typeof i[e[r]]!="undefined"?t[e[r]]=i[e[r]]:t[e[r]]=null}else t=i;return t},r.prototype.filter=function(e){var t,r={},i=n();typeof e=="string"&&(e=new RegExp(e));for(t in i)t.match(e)&&(r[t]=i[t]);return r},r.prototype.set=function(e,n,r){if(typeof r!="object"||r===null)r={};typeof n=="undefined"||n===null?(n="",r.hoursToLive=-8760):typeof n!="string"&&(n=store.stringify(n));var i=t(r);document.cookie=e+"="+encodeURIComponent(n)+i},r.prototype.del=function(e,t){var n={},r;if(typeof t!="object"||t===null)t={};typeof e=="boolean"&&e===!0?n=this.get():typeof e=="string"&&(n[e]=!0);for(r in n)typeof r=="string"&&r!==""&&this.set(r,null,t)},r.prototype.test=function(){var e=!1,t="cT",n="data";return this.set(t,n),this.get(t)===n&&(this.del(t),e=!0),e},r.prototype.setOptions=function(t){typeof t!="object"&&(t=null),i=e(t)},new r}();e.test()&&store.addType("cookie",function(t,n,r){return"undefined"==typeof t?e.get():"undefined"==typeof n?e.get(t):n===null?(e.del(t),null):e.set(t,n,r)})})()}(this)