/**
 * # Shelf.JS 
 * 
 * Persistent Client-Side Storage @VERSION
 * 
 * Copyright 2012 Stefano Balietti
 * GPL licenses.
 * 
 * ---
 * 
 */
(function(e){var t="0.3",n=e.store=function(e,t,r,i){r=r||{},i=r.type&&r.type in n.types?r.type:n.type;if(!i||!n.types[i]){n.log("Cannot save/load value. Invalid storage type selected: "+i,"ERR");return}return n.log("Accessing "+i+" storage"),n.types[i](e,t,r)};n.name="__shelf__",n.verbosity=10,n.types={};var r=null;Object.defineProperty(n,"type",{set:function(e){return"undefined"==typeof n.types[e]?(n.log("Cannot set store.type to an invalid type: "+e),!1):(r=e,e)},get:function(){return r},configurable:!1,enumerable:!0}),n.addType=function(e,t){n.types[e]=t,n[e]=function(t,r,i){return i=i||{},i.type=e,n(t,r,i)};if(!n.type||n.type==="volatile")n.type=e},n.error=function(){return"shelf quota exceeded"},n.log=function(e){n.verbosity>0&&console.log("Shelf v."+t+": "+e)},Object.defineProperty(n,"persistent",{set:function(){},get:function(){return n.types.length?n.types.length===1&&n.type==="volatile"?!1:!0:!1},configurable:!1}),n.decycle=function(e){return JSON&&JSON.decycle&&"function"==typeof JSON.decycle&&(e=JSON.decycle(e)),e},n.retrocycle=function(e){return JSON&&JSON.retrocycle&&"function"==typeof JSON.retrocycle&&(e=JSON.retrocycle(e)),e},n.stringify=function(e){if(!JSON||!JSON.stringify||"function"!=typeof JSON.stringify)throw new Error("JSON.stringify not found. Received non-string value and could not serialize.");return e=n.decycle(e),JSON.stringify(e)},n.parse=function(e){if("undefined"==typeof e)return undefined;if(JSON&&JSON.parse&&"function"==typeof JSON.parse)try{e=JSON.parse(e)}catch(t){n.log("Error while parsing a value: "+t,"ERR"),n.log(e)}return e=n.retrocycle(e),e},function(){function r(e){return n.parse(n.stringify(e))}var e={},t={};n.addType("volatile",function(n,i,s){return n?i===undefined?r(e[n]):(t[n]&&(clearTimeout(t[n]),delete t[n]),i===null?(delete e[n],null):(e[n]=i,s.expires&&(t[n]=setTimeout(function(){delete e[n],delete t[n]},s.expires)),i)):r(e)})}()})("undefined"!=typeof module&&"undefined"!=typeof module.exports?module.exports:this),function(e){var t=e.store;if(!t){console.log("fs.shelf.js: shelf.js core not found. File system storage not available.");return}var n=require("fs"),r=require("path"),i=require("util"),s=function(e,t,r){var i,s;return i=n.createReadStream(e),s=n.createWriteStream(t),i.on("end",function(){return r(null)}),i.pipe(s)},o={},u=t.name||"shelf.out",a=function(e,r){var i=e||i;if(!i)return t.log("You must specify a valid file.","ERR"),!1;var o="."+i;s(i,o,function(){var e=t.stringify(r);e=e.substr(1,e=e.substr(0,e.legth-1)),n.writeFile(i,e,"utf-8",function(e){if(e)throw e;return n.unlink(o,function(e){if(e)throw e}),!0})})},f=function(e,r,i){var s=e||s;if(!s)return t.log("You must specify a valid file.","ERR"),!1;if(!r)return;var o=t.stringify(r)+": "+t.stringify(i)+",\n";return n.appendFileSync(s,o,"utf-8")},l=function(e,r){var i=e||i;if(!i)return t.log("You must specify a valid file.","ERR"),!1;var s=n.readFileSync(i,"utf-8");s=s.substr(0,s.length-2);var o=t.parse("{"+s+"}");return r?o[r]:o},c=function(e,t){u=e||u;var n=l(u);return delete n[t],a(u,n),null};t.addType("fs",function(e,t,n){var r=n.file||u;return e?t===undefined?l(r,e):(o[e]&&(clearTimeout(o[e]),c(r,e)),t===null?(c(r,e),null):(f(u,e,t),n.expires&&(o[e]=setTimeout(function(){c(u,e)},n.expires)),t)):l(r)})}("undefined"!=typeof module&&"function"==typeof require?module.exports.store||module.parent.exports:{})